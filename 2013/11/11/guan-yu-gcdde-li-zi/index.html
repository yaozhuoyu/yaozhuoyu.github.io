<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>关于GCD的例子 | ioser</title>
  <meta name="author" content="yaozhuoyu">
  
  <meta name="description" content="yaozhuoyu’s Blog for iOS">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="关于GCD的例子"/>
  <meta property="og:site_name" content="ioser"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">
  <link rel="alternate" href="/atom.xml" title="ioser" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F00c4ebc5875ee20b2e8dd46ded23d318' type='text/javascript'%3E%3C/script%3E"));
</script>

</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <h1><a href="/">ioser</a></h1>
  <h2><a href="/">记录iOS点点滴滴</a></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div></header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper"><article class="post">
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2013-11-11T13:21:00.000Z"><a href="/2013/11/11/guan-yu-gcdde-li-zi/">2013-11-11</a></time>
      
      
  
    <h1 class="title">关于GCD的例子</h1>
  

    </header>
    <div class="entry">
      
        <p>在iOS开发中，相信很多人都用过gcd，关于gcd的概念以及具体用法网上有很多可以看的资料，方便学习。但是，gcd中包含很多函数，其中有一些我们不常见的函数、概念，本篇文章主要对这一部分内容做分析。<br><a id="more"></a></p>
<h2 id="1-为Queue提供一个final处理函数">1.为Queue提供一个final处理函数</h2>
<p>当我们创建一个串行Queue的时候，有些时候想在queue释放的时候，做一些处理，比如分配内存的释放等等，这时就需要给Queue设置一个finalizer函数，通过方法dispatch_set_finalizer_f设置，下面是一个例子：</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> MyDataContext{</div><div class="line">    <span class="keyword">int</span> length;</div><div class="line">    <span class="keyword">char</span> *data;</div><div class="line">}MyDataContext;</div><div class="line"></div><div class="line"><span class="keyword">void</span> myFinalizerFunction(<span class="keyword">void</span> *context)</div><div class="line">{</div><div class="line">    MyDataContext* theData = (MyDataContext*)context;</div><div class="line">    <span class="comment">// Clean up the contents of the structure</span></div><div class="line">    </div><div class="line">    <span class="comment">// Now release the structure itself.</span></div><div class="line">    free(theData);</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"======= finalizer function"</span>);</div><div class="line">}</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">FirstViewController</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)viewDidLoad</div><div class="line">{</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    MyDataContext*  data = (MyDataContext*) malloc(<span class="keyword">sizeof</span>(MyDataContext));</div><div class="line">    <span class="built_in">dispatch_queue_t</span> myQueue = dispatch_queue_create(<span class="string">"my.queue"</span>, <span class="literal">NULL</span>);</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (myQueue) {</div><div class="line">        dispatch_set_context(myQueue, data);</div><div class="line">        dispatch_set_finalizer_f(myQueue, &myFinalizerFunction);</div><div class="line">    }</div><div class="line">    </div><div class="line">}</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>

<p>因为创建的Queue作用域在viewDidLoad中，当函数结束的时候，queue会被释放，调用函数myFinalizerFunction，运行结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">39</span>:<span class="number">08.039</span> podProject[<span class="number">4021</span>:<span class="number">1803</span>] ======= finalizer function</div></pre></td></tr></table></figure>

<h2 id="2-disptach_apply">2.disptach_apply</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> dispatch_apply(</div><div class="line">   size_t iterations,</div><div class="line">   dispatch_queue_t <span class="built_in">queue</span>,</div><div class="line">   <span class="keyword">void</span> (^block)(</div><div class="line">   size_t));</div></pre></td></tr></table></figure>

<p>函数dispatch_apply，可以将一个for循环改造成并发运行，当所有的block运行完成之后，此函数才会返回。一般传入的queue都是并发的queue，传入串行queue就失去意义了。下面是一个例子：</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (<span class="type">void</span>)viewDidLoad</div><div class="line">{</div><div class="line">    [super viewDidLoad];</div><div class="line">    dispatch_queue_t currentQueue = dispatch_get_global_queue(<span class="type">DISPATCH_QUEUE_PRIORITY_DEFAULT</span>, <span class="number">0</span>);</div><div class="line">    </div><div class="line">    dispatch_apply(<span class="number">5</span>, currentQueue, ^(size_t index){</div><div class="line">        <span class="type">int</span> <span class="literal">result</span> = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</div><div class="line">            <span class="literal">result</span> += i + index;</div><div class="line">        }</div><div class="line">        <span class="type">NSLog</span>(@<span class="string">"current index %zu result %d"</span>, index, <span class="literal">result</span>);</div><div class="line">    });</div><div class="line">    <span class="type">NSLog</span>(@<span class="string">"=========end"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">53</span>:<span class="number">19.199</span> podProject[<span class="number">4077</span>:<span class="number">60</span>b] current index <span class="number">0</span> result <span class="number">4950</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">53</span>:<span class="number">19.202</span> podProject[<span class="number">4077</span>:<span class="number">3707</span>] current index <span class="number">1</span> result <span class="number">5050</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">53</span>:<span class="number">19.203</span> podProject[<span class="number">4077</span>:<span class="number">3707</span>] current index <span class="number">3</span> result <span class="number">5250</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">53</span>:<span class="number">19.203</span> podProject[<span class="number">4077</span>:<span class="number">60</span>b] current index <span class="number">2</span> result <span class="number">5150</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">53</span>:<span class="number">19.206</span> podProject[<span class="number">4077</span>:<span class="number">3707</span>] current index <span class="number">4</span> result <span class="number">5350</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">11</span> <span class="number">21</span>:<span class="number">53</span>:<span class="number">19.208</span> podProject[<span class="number">4077</span>:<span class="number">60</span>b] =========end</div></pre></td></tr></table></figure>

<p>使用起来非常简单，但是要注意一种情况，dispatch_apply函数中传入的queue一定不能和dispatch_apply运行的queue为同一个queue，否则会死锁。下面的例子注定死锁。</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (<span class="type">void</span>)viewDidLoad</div><div class="line">{</div><div class="line">    [super viewDidLoad];</div><div class="line">    dispatch_apply(<span class="number">5</span>, dispatch_get_main_queue(), ^(size_t index){</div><div class="line">        <span class="type">int</span> <span class="literal">result</span> = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) {</div><div class="line">            <span class="literal">result</span> += i + index;</div><div class="line">        }</div><div class="line">        <span class="type">NSLog</span>(@<span class="string">"current index %zu result %d"</span>, index, <span class="literal">result</span>);</div><div class="line">    });</div><div class="line">    <span class="type">NSLog</span>(@<span class="string">"=========end"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="3-使用dispatch_semaphore">3.使用dispatch semaphore</h2>
<p>dispatch semaphore和系统的semaphore相似，但是比系统的更有效，因为dispatch semaphore只会在资源数量不够用的时候才去调用系统内核处理。</p>
<p>下面是一个简单的例子：</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad</div><div class="line">{</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</div><div class="line">    dispatch_semaphore_t semaphore = dispatch_semaphore_create(<span class="number">1</span>);</div><div class="line">    </div><div class="line">    <span class="built_in">NSMutableArray</span> *array = [[<span class="built_in">NSMutableArray</span> alloc] init];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) {</div><div class="line">        <span class="built_in">dispatch_async</span>(queue, ^{</div><div class="line">            dispatch_semaphore_wait(semaphore, DISPATCH_TIME_FOREVER);</div><div class="line">            [array addObject:[<span class="built_in">NSNumber</span> numberWithInt:i]];</div><div class="line">            dispatch_semaphore_signal(semaphore);</div><div class="line">            <span class="built_in">NSLog</span>(<span class="string">@"current %d"</span>, i);</div><div class="line">        });</div><div class="line">    }</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewdidLoad end......."</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>运行结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.964</span> podProject[<span class="number">4591</span>:<span class="number">60</span>b] viewdidLoad end.......</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.965</span> podProject[<span class="number">4591</span>:<span class="number">3707</span>] current <span class="number">1</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.966</span> podProject[<span class="number">4591</span>:<span class="number">3707</span>] current <span class="number">2</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.965</span> podProject[<span class="number">4591</span>:<span class="number">1803</span>] current <span class="number">0</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.971</span> podProject[<span class="number">4591</span>:<span class="number">3707</span>] current <span class="number">3</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.971</span> podProject[<span class="number">4591</span>:<span class="number">1803</span>] current <span class="number">4</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.974</span> podProject[<span class="number">4591</span>:<span class="number">3</span>d03] current <span class="number">5</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.976</span> podProject[<span class="number">4591</span>:<span class="number">3707</span>] current <span class="number">6</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.977</span> podProject[<span class="number">4591</span>:<span class="number">3</span>e03] current <span class="number">7</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.977</span> podProject[<span class="number">4591</span>:<span class="number">1803</span>] current <span class="number">8</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">10</span>:<span class="number">38</span>:<span class="number">18.978</span> podProject[<span class="number">4591</span>:<span class="number">3</span>d03] current <span class="number">9</span></div></pre></td></tr></table></figure>

<h2 id="4-使用dispatch_group">4.使用dispatch group</h2>
<p>使用disptach group可以实现监听一组任务完成，在一组任务完成之后在通知执行其他操作。其中经常使用到的函数有：</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="literal">void</span> dispatch_group_async(</div><div class="line">   dispatch_group_t <span class="keyword">group</span>,</div><div class="line">   dispatch_queue_t <span class="built_in">queue</span>,</div><div class="line">   dispatch_block_t block);</div></pre></td></tr></table></figure>

<p>dispatch_group_async函数会提交block到指定的queue，并使其和group连接起来。</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="literal">void</span> dispatch_group_notify(</div><div class="line">   dispatch_group_t <span class="keyword">group</span>,</div><div class="line">   dispatch_queue_t <span class="built_in">queue</span>,</div><div class="line">   dispatch_block_t block);</div></pre></td></tr></table></figure>

<p>dispatch_group_notify函数会提交一个block到指定的queue，只有在先前提交到group的blocks都执行完成之后，此block还会执行。</p>
<p>看一个例子：</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad</div><div class="line">{</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</div><div class="line">    </div><div class="line">    dispatch_group_t group = dispatch_group_create();</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add block 1"</span>);</div><div class="line">    dispatch_group_async(group, queue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 1 start sleep"</span>);</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 1 finish sleep"</span>);</div><div class="line">    });</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add block 2"</span>);</div><div class="line">    dispatch_group_async(group, queue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 2 start sleep"</span>);</div><div class="line">        sleep(<span class="number">2</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 2 finish sleep"</span>);</div><div class="line">    });</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add block 3"</span>);</div><div class="line">    dispatch_group_async(group, queue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 3 start sleep"</span>);</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 3 finish sleep"</span>);</div><div class="line">    });</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add block notify"</span>);</div><div class="line">    dispatch_group_notify(group, queue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"dispatch group notify exe"</span>);</div><div class="line">    });</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewdidLoad end......."</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">25.359</span> podProject[<span class="number">4660</span>:<span class="number">60</span>b] add block <span class="number">1</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">25.361</span> podProject[<span class="number">4660</span>:<span class="number">1803</span>] block <span class="number">1</span> start sleep</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">25.361</span> podProject[<span class="number">4660</span>:<span class="number">60</span>b] add block <span class="number">2</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">25.364</span> podProject[<span class="number">4660</span>:<span class="number">60</span>b] add block <span class="number">3</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">25.364</span> podProject[<span class="number">4660</span>:<span class="number">3707</span>] block <span class="number">2</span> start sleep</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">25.365</span> podProject[<span class="number">4660</span>:<span class="number">60</span>b] add block notify</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">25.366</span> podProject[<span class="number">4660</span>:<span class="number">3</span>c03] block <span class="number">3</span> start sleep</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">25.367</span> podProject[<span class="number">4660</span>:<span class="number">60</span>b] viewdidLoad end.......</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">26.364</span> podProject[<span class="number">4660</span>:<span class="number">1803</span>] block <span class="number">1</span> finish sleep</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">26.369</span> podProject[<span class="number">4660</span>:<span class="number">3</span>c03] block <span class="number">3</span> finish sleep</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">27.367</span> podProject[<span class="number">4660</span>:<span class="number">3707</span>] block <span class="number">2</span> finish sleep</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">05</span>:<span class="number">27.369</span> podProject[<span class="number">4660</span>:<span class="number">3707</span>] dispatch group notify exe</div></pre></td></tr></table></figure>

<p>看另外一个函数</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> dispatch_group_wait(</div><div class="line">   dispatch_group_t <span class="keyword">group</span>,</div><div class="line">   dispatch_time_t timeout);</div></pre></td></tr></table></figure>

<p>dispatch_group_wait函数会等待先前和group相关联的block执行完成，或者超时返回。下面是一个例子：</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad</div><div class="line">{</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, <span class="number">0</span>);</div><div class="line">    </div><div class="line">    dispatch_group_t group = dispatch_group_create();</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add block 1"</span>);</div><div class="line">    dispatch_group_async(group, queue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 1 start sleep"</span>);</div><div class="line">        sleep(<span class="number">1</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 1 finish sleep"</span>);</div><div class="line">    });</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add block 2"</span>);</div><div class="line">    dispatch_group_async(group, queue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 2 start sleep"</span>);</div><div class="line">        sleep(<span class="number">2</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 2 finish sleep"</span>);</div><div class="line">    });</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"add group wait"</span>);</div><div class="line">    dispatch_group_wait(group, DISPATCH_TIME_FOREVER);</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewdidLoad end......."</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">57.957</span> podProject[<span class="number">4725</span>:<span class="number">60</span>b] add block <span class="number">1</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">57.959</span> podProject[<span class="number">4725</span>:<span class="number">60</span>b] add block <span class="number">2</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">57.961</span> podProject[<span class="number">4725</span>:<span class="number">60</span>b] add group wait</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">57.961</span> podProject[<span class="number">4725</span>:<span class="number">3</span>a03] block <span class="number">2</span> start sleep</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">57.959</span> podProject[<span class="number">4725</span>:<span class="number">1803</span>] block <span class="number">1</span> start sleep</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">58.963</span> podProject[<span class="number">4725</span>:<span class="number">1803</span>] block <span class="number">1</span> finish sleep</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">59.963</span> podProject[<span class="number">4725</span>:<span class="number">3</span>a03] block <span class="number">2</span> finish sleep</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">11</span>:<span class="number">20</span>:<span class="number">59.965</span> podProject[<span class="number">4725</span>:<span class="number">60</span>b] viewdidLoad end.......</div></pre></td></tr></table></figure>

<p>可以看出，dispatch_group_wait会阻塞当前线程。</p>
<p>最后看两个函数</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> dispatch_group_enter(</div><div class="line">   dispatch_group_t <span class="keyword">group</span>);</div><div class="line"><span class="keyword">void</span> dispatch_group_leave(</div><div class="line">   dispatch_group_t <span class="keyword">group</span>);</div></pre></td></tr></table></figure>

<p>这两个函数是成对调用的，dispatch_group_enter函数表示一个block进入group，调用此函数会增加group中task的数量。dispatch_group_leave则相反。<br>dispatch_group_async函数其实就等价于如下实现：</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">void</div><div class="line">     <span class="function">dispatch_group_async</span>(dispatch_group_t group, dispatch_queue_t queue, dispatch_block_t <span class="value">block</span>)</div><div class="line">     {</div><div class="line">             <span class="function">dispatch_retain</span>(group);</div><div class="line">             <span class="function">dispatch_group_enter</span>(group);</div><div class="line">             <span class="function">dispatch_async</span>(queue, ^{</div><div class="line">                     <span class="function">block</span>();</div><div class="line">                     <span class="function">dispatch_group_leave</span>(group);</div><div class="line">                     <span class="function">dispatch_release</span>(group);</div><div class="line">             });</div><div class="line">     }</div></pre></td></tr></table></figure>

<p>使用dispatch_group_enter函数和dispatch_group_leave函数可以方便的把系统提供的异步函数加入到一个group中。例如对于NSURLConnection的函数</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">+ (void)sendAsynchronousRequest:(NSURLRequest <span class="keyword">*</span>)request </div><div class="line">        queue:(NSOperationQueue <span class="keyword">*</span>)queue </div><div class="line">        completionHandler:(void (^)(NSURLResponse<span class="keyword">*</span>, NSData<span class="keyword">*</span>, NSError<span class="keyword">*</span>))handler</div></pre></td></tr></table></figure>

<p>我们可以在写一个能将其加入group的函数</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="subst">+</span> (<span class="literal">void</span>)withGroup:(dispatch_group_t)<span class="keyword">group</span> </div><div class="line">        sendAsynchronousRequest:(NSURLRequest <span class="subst">*</span>)request </div><div class="line">        <span class="built_in">queue</span>:(NSOperationQueue <span class="subst">*</span>)<span class="built_in">queue</span> </div><div class="line">        completionHandler:(<span class="literal">void</span> (^)(NSURLResponse<span class="subst">*</span>, NSData<span class="subst">*</span>, NSError<span class="subst">*</span>))handler</div><div class="line">{</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">group</span> <span class="subst">==</span> <span class="built_in">NULL</span>) {</div><div class="line">        <span class="preprocessor">[</span><span class="built_in">self</span> sendAsynchronousRequest:request </div><div class="line">                                <span class="built_in">queue</span>:<span class="built_in">queue</span> </div><div class="line">                    completionHandler:handler<span class="preprocessor">]</span><span class="markup">;</span></div><div class="line">    } else {</div><div class="line">        dispatch_group_enter(group);</div><div class="line">        <span class="preprocessor">[</span><span class="built_in">self</span> sendAsynchronousRequest:request </div><div class="line">                                <span class="built_in">queue</span>:<span class="built_in">queue</span> </div><div class="line">                    completionHandler:^(NSURLResponse <span class="subst">*</span>response, NSData <span class="subst">*</span><span class="built_in">data</span>, NSError <span class="subst">*</span>error){</div><div class="line">            handler(response, <span class="built_in">data</span>, error);</div><div class="line">            dispatch_group_leave(<span class="keyword">group</span>);</div><div class="line">        }<span class="preprocessor">]</span><span class="markup">;</span></div><div class="line">    }</div><div class="line">}</div></pre></td></tr></table></figure>

<h2 id="5-dispatch_after">5.dispatch_after</h2>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="type">void</span> dispatch_after(</div><div class="line">   dispatch_time_t <span class="keyword">when</span>,</div><div class="line">   dispatch_queue_t queue,</div><div class="line">   dispatch_block_t <span class="keyword">block</span>);</div></pre></td></tr></table></figure>

<p>dispatch_after函数实现延迟执行某动作，时间并不是很精确，实际上是过多久将Block追加到Queue中，而不是执行该动作，如果此时queue中的任务很多，没有执行完毕，那么新添加的这个动作就要继续推迟。</p>
<p>看下面的例子：</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad</div><div class="line">{</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"sleep start"</span>);</div><div class="line">    <span class="built_in">dispatch_async</span>(dispatch_get_main_queue(), ^{</div><div class="line">        sleep(<span class="number">10</span>);</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"sleep 10s finish"</span>);</div><div class="line">    });</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"start dispatch after"</span>);</div><div class="line">    dispatch_time_t delayTime = dispatch_time(DISPATCH_TIME_NOW, <span class="number">5</span>ull * NSEC_PER_SEC);</div><div class="line">    dispatch_after(delayTime, dispatch_get_main_queue(), ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"after 5s , execute!"</span>);</div><div class="line">    });</div><div class="line">    </div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"end viewdidload"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>执行结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">36.113</span> podProject[<span class="number">4783</span>:<span class="number">60</span>b] sleep start</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">36.115</span> podProject[<span class="number">4783</span>:<span class="number">60</span>b] start dispatch after</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">36.116</span> podProject[<span class="number">4783</span>:<span class="number">60</span>b] end viewdidload</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">46.128</span> podProject[<span class="number">4783</span>:<span class="number">60</span>b] sleep <span class="number">10</span>s finish</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">12</span>:<span class="number">23</span>:<span class="number">46.131</span> podProject[<span class="number">4783</span>:<span class="number">60</span>b] after <span class="number">5</span>s , execute!</div></pre></td></tr></table></figure>

<p>因为queue sleep了10秒，所以造成了这样的结果。</p>
<h2 id="6-dispatch_set_target_queue">6.dispatch_set_target_queue</h2>
<p>看函数</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> dispatch_set_target_queue(</div><div class="line">   dispatch_object_t <span class="keyword">object</span>,</div><div class="line">   dispatch_queue_t queue);</div></pre></td></tr></table></figure>


<p>所有的用户队列都有一个目标队列概念。从本质上讲，一个用户队列实际上是不执行任何任务的，但是它会将任务传递给它的目标队列来执行。通常，目标队列是默认优先级的全局队列。</p>
<p>用户队列的目标队列可以用函数 dispatch_set_target_queue来修改。我们可以将任意dispatch queue传递给这个函数，甚至可以是另一个用户队列，只要别构成循环就行。这个函数可以用来设定用户队列的优先级。比如我们可以将用户队列的目标队列设定为低优先级的全局队列，那么我们的用户队列中的任务都会以低优先级执行。高优先级也是一样道理。</p>
<p>有一个用途，是将用户队列的目标定为main queue。这会导致所有提交到该用户队列的block在主线程中执行。这样做来替代直接在主线程中执行代码的好处在于，我们的用户队列可以单独地被挂起和恢复，还可以被重定目标至一个全局队列，然后所有的block会变成在全局队列上执行（只要你确保你的代码离开主线程不会有问题）。</p>
<p>还有一个用途，是将一个用户队列的目标队列指定为另一个用户队列。这样做可以强制多个队列相互协调地串行执行，这样足以构建一组队列，通过挂起和暂停那个目标队列，我们可以挂起和暂停整个组。</p>
<p>下面一个例子，将一个创建的串行queue的目标队列设置为mian queue。</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad</div><div class="line">{</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"========current thread %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    <span class="built_in">dispatch_queue_t</span> myQueue = dispatch_queue_create(<span class="string">"my queue"</span>, <span class="literal">NULL</span>);</div><div class="line">    dispatch_set_target_queue(myQueue, dispatch_get_main_queue());</div><div class="line">    <span class="built_in">dispatch_async</span>(myQueue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"*******current thread %@"</span>, [<span class="built_in">NSThread</span> currentThread]);</div><div class="line">    });</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"end viewdidload"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">00.509</span> podProject[<span class="number">5158</span>:<span class="number">60</span>b] ========current thread &lt;NSThread: <span class="number">0</span>x16526f60&gt;{name = (null), num = <span class="number">1</span>}</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">00.512</span> podProject[<span class="number">5158</span>:<span class="number">60</span>b] end viewdidload</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">00.524</span> podProject[<span class="number">5158</span>:<span class="number">60</span>b] *******current thread &lt;NSThread: <span class="number">0</span>x16526f60&gt;{name = (null), num = <span class="number">1</span>}</div></pre></td></tr></table></figure>

<h2 id="7-dispatch_barriers">7.dispatch barriers</h2>
<p>dispatch barriers和dispatch group很相似。dispatch barriers主要用在并发queue的同步中。用来阻拦之后添加的block，在barriers之前天机的block执行完成之后，才会执行barriers之后添加的block。</p>
<p>看下面的一个例子：</p>
<figure class="highlight objective-c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">- (<span class="keyword">void</span>)viewDidLoad</div><div class="line">{</div><div class="line">    [<span class="keyword">super</span> viewDidLoad];</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_queue_t</span> myQueue = dispatch_queue_create(<span class="string">"my concurrent queue"</span>, DISPATCH_QUEUE_CONCURRENT);</div><div class="line">    </div><div class="line">    <span class="built_in">dispatch_async</span>(myQueue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 1"</span>);</div><div class="line">    });</div><div class="line">    <span class="built_in">dispatch_async</span>(myQueue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 2"</span>);</div><div class="line">    });</div><div class="line">    <span class="built_in">dispatch_async</span>(myQueue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 3"</span>);</div><div class="line">    });</div><div class="line">    dispatch_barrier_async(myQueue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"***barrier***"</span>);</div><div class="line">    });</div><div class="line">    <span class="built_in">dispatch_async</span>(myQueue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 4"</span>);</div><div class="line">    });</div><div class="line">    <span class="built_in">dispatch_async</span>(myQueue, ^{</div><div class="line">        <span class="built_in">NSLog</span>(<span class="string">@"block 5"</span>);</div><div class="line">    });</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"viewDidLoad finish"</span>);</div><div class="line">}</div></pre></td></tr></table></figure>

<p>运行结果为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">16.545</span> podProject[<span class="number">5296</span>:<span class="number">60</span>b] viewDidLoad finish</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">16.545</span> podProject[<span class="number">5296</span>:<span class="number">1803</span>] block <span class="number">1</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">16.549</span> podProject[<span class="number">5296</span>:<span class="number">1803</span>] block <span class="number">3</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">16.545</span> podProject[<span class="number">5296</span>:<span class="number">370</span>b] block <span class="number">2</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">16.550</span> podProject[<span class="number">5296</span>:<span class="number">370</span>b] ***barrier***</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">16.555</span> podProject[<span class="number">5296</span>:<span class="number">370</span>b] block <span class="number">4</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">39</span>:<span class="number">16.555</span> podProject[<span class="number">5296</span>:<span class="number">1803</span>] block <span class="number">5</span></div></pre></td></tr></table></figure>

<p>如果将dispatch_barrier_async修改为dispatch_barrier_sync，则运行结果就变为如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">25.336</span> podProject[<span class="number">5308</span>:<span class="number">1803</span>] block <span class="number">1</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">25.336</span> podProject[<span class="number">5308</span>:<span class="number">3</span>a03] block <span class="number">2</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">25.340</span> podProject[<span class="number">5308</span>:<span class="number">1803</span>] block <span class="number">3</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">25.342</span> podProject[<span class="number">5308</span>:<span class="number">60</span>b] ***barrier***</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">25.343</span> podProject[<span class="number">5308</span>:<span class="number">60</span>b] viewDidLoad finish</div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">25.343</span> podProject[<span class="number">5308</span>:<span class="number">3</span>a03] block <span class="number">5</span></div><div class="line"><span class="number">2013</span>-<span class="number">11</span>-<span class="number">12</span> <span class="number">15</span>:<span class="number">41</span>:<span class="number">25.343</span> podProject[<span class="number">5308</span>:<span class="number">1803</span>] block <span class="number">4</span></div></pre></td></tr></table></figure>

<p>使用起来比dispatch group简单。</p>
<p>关于dispatch的使用先介绍这7个，下篇文章将讲一下dispatch I/O。</p>

      
    </div>
    <footer>
      
        
  
  <div class="categories">
    <a href="/categories/iOS/">iOS</a>
  </div>

        
  
  <div class="tags">
    <a href="/tags/GCD/">GCD</a>
  </div>

        <div class="bdsharebuttonbox"><a href="#" class="bds_more" data-cmd="more"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博"></a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a></div>
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"1","bdSize":"16"},"share":{},"image":{"viewList":["qzone","tsina","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
<!-- UY BEGIN -->
<div id="uyan_frame"></div>
<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1853813"></script>
<!-- UY END -->
</section>

</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="搜索">
    <input type="hidden" name="q" value="site:ioser.cc">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">分类</h3>
  <ul class="entry">
  
    <li><a href="/categories/Swift/">Swift</a><small>2</small></li>
  
    <li><a href="/categories/git/">git</a><small>3</small></li>
  
    <li><a href="/categories/iOS/">iOS</a><small>11</small></li>
  
    <li><a href="/categories/生活/">生活</a><small>3</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">标签</h3>
  <ul class="entry">
  
    <li><a href="/tags/GCD/">GCD</a><small>2</small></li>
  
    <li><a href="/tags/Initializers/">Initializers</a><small>1</small></li>
  
    <li><a href="/tags/NSOperation/">NSOperation</a><small>2</small></li>
  
    <li><a href="/tags/NSOperation-WWDC-NSOperationQueue/">NSOperation WWDC NSOperationQueue</a><small>1</small></li>
  
    <li><a href="/tags/NSOperationQueue-NSOperation/">NSOperationQueue NSOperation</a><small>1</small></li>
  
    <li><a href="/tags/NSRunLoop/">NSRunLoop</a><small>1</small></li>
  
    <li><a href="/tags/NSTimer/">NSTimer</a><small>1</small></li>
  
    <li><a href="/tags/Swift/">Swift</a><small>2</small></li>
  
    <li><a href="/tags/UIView-AutoLayout/">UIView AutoLayout</a><small>1</small></li>
  
    <li><a href="/tags/function/">function</a><small>1</small></li>
  
    <li><a href="/tags/git/">git</a><small>3</small></li>
  
    <li><a href="/tags/iOS7/">iOS7</a><small>1</small></li>
  
  </ul>
</div>


  <iframe width="100%" height="550" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=550&fansRow=1&ptype=0&speed=0&skin=5&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=1732353090&verifier=eb816cbb&dpc=1"></iframe>
</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 yaozhuoyu
  
</div>
<div class="clearfix"></div></footer>
  <script src="//libs.baidu.com/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>